<?php error_reporting(0);
header('Content-type: text/html');
@ini_set('magic_quotes_runtime', 0);
$optArray = unserialize('a:8:{s:11:"ss_order_id";s:4:"8nUs";s:10:"ss_docroot";s:68:"XFxib3N3aW5mczA3XGhvbWVcdXNlcnNcd2ViXGI0NTlcZG9tLmpvaG5zdHJhY2tjb20=";s:12:"ss_full_path";s:80:"XFxib3N3aW5mczA3XGhvbWVcdXNlcnNcd2ViXGI0NTlcZG9tLmpvaG5zdHJhY2tjb21cd29yZHByZXNz";s:8:"filename";s:20:"wordpress-6gtteg.tgz";s:11:"data_exists";i:1;s:18:"sample_data_exists";i:0;s:13:"ss_install_in";s:12:"d29yZHByZXNz";s:11:"ss_filename";s:20:"wordpress-trnfwu.tgz";}');
$dbArray = unserialize('a:5:{s:9:"ss_dbpass";s:16:"NW81R09ZWFpSQQ==";s:9:"ss_dbname";s:14:"wrd_727ahii7n3";s:11:"ss_dbprefix";s:3:"wp_";s:9:"ss_dbhost";s:32:"johnstrackcom.domaincommysql.com";s:9:"ss_dbuser";s:11:"wrdrrp8i12O";}');
@ini_set("memory_limit", "32M"); $passthru = ((function_exists('passthru') && strtolower(PHP_OS) != 'winnt') ? true : false); foreach (array('ss_install_in', 'ss_docroot', 'ss_full_path') as $dec) { if (array_key_exists($dec, $optArray)) { $optArray[$dec] = base64_decode($optArray[$dec]); } } $newDir = rtrim($optArray['ss_full_path'], '/ '); @chdir('.'); if (getcwd() != $newDir && false === empty($newDir)) { @chdir($newDir) or die('<ss>status:195|dump:Failed change to dir "'.$newDir.'". We\'re in "'.getcwd().'"</ss>'); } switch ($_GET['s']) { default: case '1': $compress = array_pop(explode(".",$optArray['filename'])); $cmd = array(); if ($compress == "tgz" || $compress == "gz") { if ($passthru) { ob_start(); passthru('tar --no-same-owner -xzf '.$optArray['filename']); ob_end_clean(); ob_start(); passthru('tar -tzf '.$optArray['filename'].' 2>/dev/null'); $list = preg_split("/\n/", ob_get_contents()); ob_end_clean(); } else { $list = _untar($optArray['filename'], 'tgz'); } } elseif ($compress == "tar") { if ($passthru) { ob_start(); passthru("tar --no-same-owner -xf ".$optArray['filename']); ob_end_clean(); ob_start(); passthru('tar -tf '.$optArray['filename'].' 2>/dev/null'); $list = preg_split("/\n/", ob_get_contents()); ob_end_clean(); } else { $list = _untar($optArray['filename'], 'tar'); } } if (strtolower(PHP_OS) != 'winnt') { $chmod_lists = array('0755' => array(), '0644' => array()); foreach ($list as $l) { $l = trim($l); if (empty($l)) { continue; } if (is_file($l) && substr($l, -3) != 'php') { if (substr($l, -3) == 'cgi') { $chmod_lists['0755'][] = $l; } else { $chmod_lists['0644'][] = $l; } } elseif (is_dir($l) && false === in_array($l, array('.', '..'))) { $chmod_lists['0755'][] = $l; } } ob_start(); foreach ($chmod_lists as $mode => $list) { $cnt = count($list); for ($i=0; $i<=$cnt; $i+=100) { $go = array_slice($list, $i, 100); if ($passthru) { passthru("chmod ".$mode." ".implode(" ", $go)); } else { foreach ($go as $g) { chmod($g, octdec($mode)); } } } } ob_end_clean(); } break; case '2': if (is_file($newDir.'/data.sql') && false === empty($optArray['data_exists'])) { if (function_exists('db_info_snippet')) { $dbArray = db_info_snippet(); } $import = _importdb($dbArray, $newDir."/data.sql"); if (false === $import) { die('<ss>status:242|dbinfo:'.var_export($dbArray, true).'</ss>'); } @unlink($newDir."/data.sql"); } @unlink($optArray['filename']); @unlink(__FILE__); break; } print "<ss>status:200</ss>"; function _importdb($db, $sf) { $dbg = array(); if (is_file($sf) && extension_loaded('mysql')) { if (false === ($conn = @mysql_connect($db['ss_dbhost'], $db['ss_dbuser'], base64_decode($db['ss_dbpass'])))) { return false; } if (false === @mysql_select_db($db['ss_dbname'], $conn)) { return false; } else { mysql_query("SET foreign_key_checks = 0"); $q = ''; $fh = fopen($sf, 'r'); if (false === is_resource($fh)) { return false; } while ($q == '') { $dl = ''; while (!feof($fh) && !preg_match("/; ?$/s", $dl)) { $line = @fgets($fh, 16384); if (preg_match("/^(#|--|\/\*\!)/", $line) && empty($dl)) { continue; } $dl .= trim($line); } if (empty($dl)) { break; } $q .= trim(str_replace(array("\r\n", "\r"), "\n", $dl)); if (empty($q)) { continue; } mysql_query($q, $conn); if (mysql_error()) { if (in_array(mysql_errno(), array(1050, 1142))) { return false; } if (in_array(mysql_errno(), array(1060, 1061, 1091))) { continue; } else { $dbg[] = 'bad_query['.base64_encode($q."\n".mysql_error()).']'; } } $q = ''; } @fclose($fh); @mysql_close($conn); } } else { return false; } return $dbg; } function _untar($filename, $format, $mode='untar') { $returnValue = array(); $listMode = ($mode == "list") ? true:false; $gzip = ($format == 'tgz') ? true:false; if ($gzip) { $ghandle = gzopen($filename, 'r'); $reghandle = fopen($filename.'gzconvert', 'w'); gzseek($ghandle, 0); while ($temp = gzread($ghandle, 1048576)) {fwrite($reghandle, $temp);} fclose($reghandle); gzclose($ghandle); $filename = $filename.'gzconvert'; } $tarfile=@fopen($filename, 'r'); while (!feof($tarfile)) { $readdata=fread($tarfile,512); if (substr($readdata,257,5)=='ustar') { $tfilename=substr($readdata,0,100); $indicator=substr($readdata,156,1); if ($indicator==5) { if (!@mkdir($tfilename)) { $levels = explode("/", $tfilename); $thestring = ""; foreach($levels as $level) { $thestring .= $level . "/"; @mkdir($thestring); } } } } } @fclose($tarfile); $tarfile=@fopen($filename, 'r'); $thetar=fopen($filename,'r'); $longlinkfound = false; while (!feof($tarfile)) { $readdata=fread($tarfile,512); if (substr($readdata,257,5)=='ustar') { $tfilename=substr($readdata,0,100); $permissions=substr($readdata,100,8); $tfilename = trim($tfilename); $indicator=substr($readdata,156,1); if ($indicator==2) { $linklocation = substr($readdata,157,100); } $offset=ftell($tarfile); $filesize=octdec(substr($readdata,124,12)); $directory = ""; } if ((!$listMode) && (substr($readdata,257,5)=='ustar')) { if ($indicator==5) { $returnValue[] = $tfilename; continue; } if ($indicator==2){ $returnValue[] = $tfilename; symlink($linklocation,$tfilename); continue; } if ($longlinkfound) { $tfilename = $longlinkfound; } if ($tfilename == '././@LongLink') { fseek($thetar,$offset); $data=@fread($thetar,$filesize); $longlinkfound = $data; continue; } else if ($longlinkfound) { $longlinkfound = false; } $fh = @fopen($tfilename,'wb'); if (!$fh) { $levels = explode("/", $tfilename); $thestring = ""; foreach($levels as $level) { $thestring .= $level . "/"; @mkdir($thestring); } $fh = @fopen($tfilename,'wb'); } fseek($thetar,$offset); $data=@fread($thetar,$filesize); @fwrite($fh,$data); @fclose($fh); @chmod($tfilename,0 . octdec(substr($permissions,3))); $returnValue[] = $tfilename; } } @fclose($thetar); @fclose($tarfile); if ($gzip){ @unlink($filename);} return $returnValue; } 
?>